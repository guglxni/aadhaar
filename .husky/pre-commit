#!/bin/sh
set -e

echo "üîç Pre-commit security scan..."

# Get staged files
FILES=$(git diff --cached --name-only)

# Block secret-like files
echo "$FILES" | grep -E '\.(key|pem|p12|cer)$|(^|/)certs/' && {
  echo "‚ùå Secret-like file staged. Move to secret store."
  exit 1
}

# Block build outputs
echo "$FILES" | grep -E '(^|/)node_modules/|(^|/)dist/' && {
  echo "‚ùå Build output staged. Fix .gitignore."
  exit 1
}

# Block env files (except .env.example)
echo "$FILES" | grep -E '\.env($|\.[^/]*$)' | grep -v '\.env\.example$' && {
  echo "‚ùå Environment file staged. Use .env.example template."
  exit 1
}

# Block duplicate status files
echo "$FILES" | grep -E '^[^/]*STATUS.*\.md$' | grep -v '^STATUS\.md$' && {
  echo "‚ùå Duplicate status file. Only STATUS.md is allowed (auto-generated)."
  exit 1
}

# Block large binaries/archives
echo "$FILES" | grep -E '\.(zip|jar|class|p12|bin)$' && {
  echo "‚ùå Binary file staged. Use external storage."
  exit 1
}

echo "‚úÖ Pre-commit security scan passed"
